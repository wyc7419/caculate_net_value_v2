<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>净值分析可视化</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <h1>📊 净值分析可视化系统</h1>
            <p class="subtitle">基于 TimescaleDB 的实时数据展示</p>
            
            <!-- 功能标签页 -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="view">📈 查看净值</button>
                <button class="tab-btn" data-tab="calculate">⚙️ 计算净值</button>
                <button class="tab-btn" data-tab="positions">📜 过去持仓</button>
            </div>
        </header>

        <!-- 查看净值面板 -->
        <div id="viewPanel" class="tab-panel active">
        <!-- 控制面板 -->
        <div class="control-panel control-panel-view">
            <!-- 第一行：时间区间 + 地址 -->
            <div class="control-row">
                <div class="control-item">
                    <label for="interval">时间区间</label>
                    <select id="interval">
                        <option value="1h" selected>1小时</option>
                        <option value="2h">2小时</option>
                        <option value="4h">4小时</option>
                        <option value="8h">8小时</option>
                        <option value="12h">12小时</option>
                        <option value="1d">1天</option>
                    </select>
                </div>

                <div class="control-item control-item-address">
                    <label for="address">账户地址</label>
                    <div class="address-input-wrapper">
                        <input type="text" id="addressSearch" placeholder="🔍 搜索或选择地址..." class="address-search-new">
                        <select id="address">
                            <option value="">请选择...</option>
                        </select>
                    </div>
                    <span class="address-count-badge" id="addressCount"></span>
                </div>
            </div>

            <!-- 第二行：选项 + 按钮 -->
            <div class="control-row control-row-actions">
                <div class="control-options">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="fromFirstTrade" checked>
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-text">从第一笔交易开始</span>
                        <span class="tooltip-trigger" data-tooltip="trade数据不全时，从第一笔交易开始会让结果更精确">?</span>
                    </label>
                </div>

                <div class="control-buttons">
                    <button id="loadBtn" class="btn btn-load">📊 加载数据</button>
                    <button id="refreshBtn" class="btn btn-refresh" title="刷新地址列表">🔄</button>
                    <button id="refreshCacheBtn" class="btn btn-refresh" title="刷新缓存">♻️</button>
                </div>
            </div>
        </div>

        <!-- 加载状态 -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>加载中...</p>
        </div>

        <!-- 错误提示 -->
        <div id="error" class="error" style="display: none;"></div>

        <!-- 统计卡片 -->
        <div id="statsCards" class="stats-cards" style="display: none;">
            <div class="stat-card">
                <div class="stat-icon">📈</div>
                <div class="stat-content">
                    <div class="stat-label">当前净值</div>
                    <div class="stat-value" id="currentNetValue">-</div>
                    <div class="stat-change" id="netValueChange">-</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                    <div class="stat-label">收益率</div>
                    <div class="stat-value" id="returnRate">-</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">💰</div>
                <div class="stat-content">
                    <div class="stat-label">累计 PnL</div>
                    <div class="stat-value" id="cumulativePnl">-</div>
                    <div class="stat-change" id="pnlChange">-</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">💼</div>
                <div class="stat-content">
                    <div class="stat-label">总资产</div>
                    <div class="stat-value" id="totalAssets">-</div>
                </div>
            </div>
        </div>

        <!-- 数据信息面板 -->
        <div id="dataInfoPanel" class="data-info-panel" style="display: none;">
            <div class="info-row">
                <div class="info-item">
                    <span class="info-label">时间区间：</span>
                    <span class="info-value" id="displayInterval">-</span>
                </div>
                <div class="info-item address-info">
                    <span class="info-label">账户地址：</span>
                    <div class="address-copy-wrapper">
                        <input type="text" id="displayAddress" readonly class="address-display-input">
                        <button id="copyAddressBtn" class="btn-copy" title="复制地址">📋 复制</button>
                    </div>
                </div>
                <div class="info-item">
                    <button id="exportCsvBtn" class="btn-export" title="导出当前数据为CSV">
                        💾 导出 CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- 图表容器 -->
        <div class="charts-container" style="display: none;">
            <!-- 主图表 -->
            <div class="chart-card">
                <h3>净值与累计 PnL 走势</h3>
                <div id="mainChart" class="chart"></div>
            </div>

            <!-- 子图表行 -->
            <div class="chart-row">
                <div class="chart-card half">
                    <h3>总资产走势</h3>
                    <div id="assetsChart" class="chart-small"></div>
                </div>
                <div class="chart-card half">
                    <h3>现货 vs 合约价值</h3>
                    <div id="accountChart" class="chart-small"></div>
                </div>
            </div>

            <!-- PnL 图表行 -->
            <div class="chart-row">
                <div class="chart-card half">
                    <h3>已实现盈亏</h3>
                    <div id="realizedPnlChart" class="chart-small"></div>
                </div>
                <div class="chart-card half">
                    <h3>虚拟盈亏</h3>
                    <div id="virtualPnlChart" class="chart-small"></div>
                </div>
            </div>

            <!-- 数据表格 -->
            <div class="data-table-card">
                <div class="table-header">
                    <h3>📋 详细数据表</h3>
                    <div class="table-actions">
                        <button id="toggleTableBtn" class="btn-toggle">收起 ▲</button>
                    </div>
                </div>
                <div class="table-wrapper" id="tableWrapper">
                    <table id="dataTable" class="data-table">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>净值</th>
                                <th>累计盈亏</th>
                                <th>总资产</th>
                                <th>总份额</th>
                                <th>现货账户</th>
                                <th>合约账户</th>
                                <th>已实现盈亏</th>
                                <th>虚拟盈亏</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
        <!-- 查看净值面板结束 -->

        <!-- 计算净值面板 -->
        <div id="calculatePanel" class="tab-panel">
            <!-- 计算模式切换 -->
            <div class="calc-mode-tabs">
                <button class="calc-mode-btn active" data-mode="single">📍 单个地址</button>
                <button class="calc-mode-btn" data-mode="batch">📋 批量计算</button>
            </div>

            <!-- 单个地址计算 -->
            <div id="singleCalcPanel" class="calc-mode-panel active">
                <div class="single-calc-panel">
                    <div class="single-calc-row">
                        <div class="single-calc-item">
                            <label for="calcInterval">时间区间</label>
                            <select id="calcInterval">
                                <option value="1h" selected>1小时</option>
                                <option value="2h">2小时</option>
                                <option value="4h">4小时</option>
                                <option value="8h">8小时</option>
                                <option value="12h">12小时</option>
                                <option value="1d">1天</option>
                            </select>
                        </div>
                        <div class="single-calc-item single-calc-item-address">
                            <label for="calcAddress">账户地址</label>
                            <input type="text" id="calcAddress" placeholder="输入完整的钱包地址 (0x...)" class="single-address-input">
                        </div>
                    </div>
                    <div class="single-calc-row single-calc-actions">
                        <div class="single-calc-options">
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="forceOverwrite">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">强制全量覆盖</span>
                                <span class="tooltip-trigger" data-tooltip="勾选后将删除该地址的所有历史数据并重新计算，用于修正历史数据错误">?</span>
                            </label>
                        </div>
                        <button id="calcBtn" class="btn btn-load">🚀 开始计算</button>
                    </div>
                </div>
            </div>

            <!-- 批量计算 -->
            <div id="batchCalcPanel" class="calc-mode-panel">
                <div class="batch-control-panel">
                    <div class="batch-row">
                        <div class="batch-item">
                            <label for="batchInterval">时间区间</label>
                            <select id="batchInterval">
                                <option value="1h" selected>1小时</option>
                                <option value="2h">2小时</option>
                                <option value="4h">4小时</option>
                                <option value="8h">8小时</option>
                                <option value="12h">12小时</option>
                                <option value="1d">1天</option>
                            </select>
                        </div>
                        <div class="batch-item">
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="batchForceOverwrite">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">强制全量覆盖</span>
                            </label>
                        </div>
                    </div>
                    <div class="batch-row">
                        <div class="batch-item batch-item-full">
                            <label for="batchAddresses">地址列表（每行一个）</label>
                            <textarea id="batchAddresses" class="batch-textarea" placeholder="0x1234...&#10;0x5678...&#10;0xabcd..."></textarea>
                            <div class="batch-address-count">已输入 <span id="batchAddressCount">0</span> 个地址</div>
                        </div>
                    </div>
                    <div class="batch-row batch-actions">
                        <button id="batchStartBtn" class="btn btn-load">🚀 开始批量计算</button>
                        <button id="batchPauseBtn" class="btn btn-secondary" disabled>⏸️ 暂停</button>
                        <button id="batchResumeBtn" class="btn btn-secondary" style="display:none;">▶️ 继续</button>
                        <button id="batchCancelBtn" class="btn btn-danger" disabled>⏹️ 取消</button>
                    </div>
                </div>

                <!-- 批量进度面板 -->
                <div id="batchProgressPanel" class="batch-progress-panel" style="display: none;">
                    <div class="progress-header">
                        <h3>📊 批量计算进度</h3>
                        <span class="progress-status" id="batchProgressStatus">准备中...</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="batchProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="progress-stats">
                        <div class="stat-item">
                            <span class="stat-label">总计</span>
                            <span class="stat-value" id="batchTotalCount">0</span>
                        </div>
                        <div class="stat-item stat-success">
                            <span class="stat-label">✅ 成功</span>
                            <span class="stat-value" id="batchSuccessCount">0</span>
                        </div>
                        <div class="stat-item stat-warning">
                            <span class="stat-label">⚠️ 快照校验警告</span>
                            <span class="stat-value" id="batchWarningCount">0</span>
                        </div>
                        <div class="stat-item stat-fail">
                            <span class="stat-label">❌ 失败</span>
                            <span class="stat-value" id="batchFailCount">0</span>
                        </div>
                        <div class="stat-item stat-skip">
                            <span class="stat-label">⏭️ 跳过</span>
                            <span class="stat-value" id="batchSkipCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">当前</span>
                            <span class="stat-value" id="batchCurrentIndex">0</span> / <span id="batchTotalIndex">0</span>
                        </div>
                    </div>
                    <div class="batch-detail-container">
                        <div class="batch-detail-header">
                            <span>详细记录</span>
                            <button id="toggleDetailBtn" class="btn-toggle">收起 ▲</button>
                        </div>
                        <div class="batch-detail-list" id="batchDetailList"></div>
                    </div>
                </div>

                <!-- 批量计算日志（放在进度面板下方） -->
                <div id="batchLogContainer" class="log-container batch-log-container" style="display: none;">
                    <div class="log-header">
                        <div>
                            <h3>📋 计算日志</h3>
                            <div id="currentLogAddress" class="current-log-address"></div>
                        </div>
                        <button id="clearBatchLogBtn" class="btn-clear">🗑️ 清空</button>
                    </div>
                    <div id="batchLogContent" class="log-content"></div>
                </div>
            </div>

            <!-- 计算状态提示 -->
            <div id="calcStatus" class="calc-status" style="display: none;"></div>

            <!-- 日志显示区域 -->
            <div id="logContainer" class="log-container" style="display: none;">
                <div class="log-header">
                    <h3>📋 计算日志</h3>
                    <button id="clearLogBtn" class="btn-clear">🗑️ 清空</button>
                </div>
                <div id="logContent" class="log-content"></div>
            </div>

            <!-- 完成操作区域 -->
            <div id="calcComplete" class="calc-complete" style="display: none;">
                <div class="complete-icon">✅</div>
                <h3>计算完成！</h3>
                <p>净值数据已成功保存到数据库</p>
                <button id="viewCalculatedBtn" class="btn-primary btn-large">
                    📊 查看净值数据
                </button>
            </div>
        </div>
        <!-- 计算净值面板结束 -->

        <!-- 过去持仓面板 -->
        <div id="positionsPanel" class="tab-panel">
            <!-- 功能介绍卡片 -->
            <div class="positions-hero">
                <div class="positions-hero-icon">📜</div>
                <h2 class="positions-hero-title">导出过去持仓</h2>
                <p class="positions-hero-desc">基于快照数据，逆向计算每笔交易前后的历史持仓状态</p>
                
                <div class="positions-features">
                    <div class="positions-feature-item">
                        <span class="feature-icon">🔍</span>
                        <span class="feature-text">精确追溯</span>
                    </div>
                    <div class="positions-feature-item">
                        <span class="feature-icon">✅</span>
                        <span class="feature-text">快照校验</span>
                    </div>
                    <div class="positions-feature-item">
                        <span class="feature-icon">💾</span>
                        <span class="feature-text">直接下载</span>
                    </div>
                    <div class="positions-feature-item">
                        <span class="feature-icon">🚀</span>
                        <span class="feature-text">不占服务器</span>
                    </div>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="positions-input-card">
                <div class="positions-input-header">
                    <span class="input-label">账户地址</span>
                    <span class="input-hint">请输入要查询的账户地址</span>
                </div>
                <div class="positions-input-group">
                    <input type="text" id="positionsAddress" class="positions-address-input" placeholder="0x...">
                    <button id="exportPositionsBtn" class="positions-export-btn">
                        <span class="btn-icon">📥</span>
                        <span class="btn-text">开始导出</span>
                    </button>
                </div>
            </div>

            <!-- 计算日志 -->
            <div id="positionsLogContainer" class="positions-log-container" style="display: none;">
                <div class="positions-log-header">
                    <div class="log-header-left">
                        <span class="log-icon">📋</span>
                        <h3 class="log-title">计算日志</h3>
                        <span class="log-status">实时输出</span>
                    </div>
                    <button id="clearPositionsLogBtn" class="positions-log-clear">
                        <span>🗑️</span>
                        <span>清空</span>
                    </button>
                </div>
                <div id="positionsLogContent" class="positions-log-content"></div>
            </div>

            <!-- 完成操作区域 -->
            <div id="positionsComplete" class="positions-complete-card" style="display: none;">
                <div class="complete-success-icon">
                    <div class="success-checkmark">✓</div>
                </div>
                <h3 class="complete-title">导出完成！</h3>
                <p id="positionsCompleteMessage" class="complete-message">持仓数据已成功计算</p>
                <button id="downloadPositionsCsvBtn" class="positions-download-btn">
                    <span class="download-icon">💾</span>
                    <span class="download-text">下载 CSV 文件</span>
                </button>
                <p class="complete-hint">💡 提示：数据将保留10分钟，请及时下载</p>
            </div>
        </div>
        <!-- 过去持仓面板结束 -->

        <!-- 页脚 -->
        <footer class="footer">
            <p>净值分析系统 | Powered by TimescaleDB & ECharts</p>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>





