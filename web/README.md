# 净值可视化 Web 应用

## 快速开始

### 启动 Web 应用

**方式1：使用批处理脚本（推荐）**
```bash
启动Web应用.bat
```

**方式2：使用 Python 直接运行**
```bash
python app.py
```

**方式3：快速启动（禁用预加载）**
```bash
# Windows
set DISABLE_PRELOAD=1
python app.py

# Linux/Mac
DISABLE_PRELOAD=1 python app.py
```

启动后访问：http://localhost:5000

---

### ⚡ 性能优化

**启动速度优化**（✨ 新特性）：
- **快速启动**：应用立即启动（~1秒），您可以立即打开网页
- **后台预加载**（默认）：首次访问时自动在后台加载所有地址，不阻塞页面访问
- **按需加载模式**：设置 `DISABLE_PRELOAD=1` 完全禁用预加载，按需加载地址

**用户体验**：
- ✅ 启动即可访问：应用启动后立即可以打开网页
- ✅ 无感知加载：首次访问触发后台预加载，不影响页面使用
- ✅ 渐进增强：后台加载完成后，所有地址访问速度更快

**工作流程**：
1. 启动应用（~1秒）
2. 立即打开网页（可正常使用）
3. 首次请求时后台开始预加载（~3-5秒，不阻塞）
4. 预加载完成后，所有访问更快

**推荐配置**：
- **开发/生产**：默认配置即可，启动快且体验好
- **极简模式**：设置 `DISABLE_PRELOAD=1`，完全按需加载

---

### 停止 Web 应用

**方式1：使用批处理脚本**
```bash
停止Web应用.bat
```

**方式2：使用 Python 脚本**
```bash
python stop_web_app.py
```

**方式3：在运行终端按 `Ctrl+C`**

---

## 功能说明

### 启动脚本（启动Web应用.bat）
- 自动检查依赖包
- 快速启动 Flask Web 服务（~1秒）
- **后台预加载所有时间区间的地址列表**（首次访问触发，不阻塞）
- 显示访问地址
- 按 Ctrl+C 停止服务

### 停止脚本（停止Web应用.bat / stop_web_app.py）
- 自动查找占用 5000 端口的进程
- 显示进程信息（PID、进程名）
- 安全终止服务
- 支持多进程场景
- 跨平台支持（Windows/Linux/Mac）

### 缓存机制
- ✅ **启动时预加载**：应用启动时自动加载所有时间区间的地址列表到内存
- ✅ **快速响应**：切换时间区间时无需查询数据库，秒级响应
- ✅ **手动刷新**：提供"♻️ 刷新缓存"按钮，添加新数据后可手动更新缓存
- ✅ **API 支持**：
  - `GET /api/cache-info` - 查看缓存信息
  - `POST /api/refresh-cache` - 刷新所有缓存

### 地址搜索功能 ✨ 新增
- ✅ **完整地址显示**：下拉框显示完整的42位地址（而非缩写）
- ✅ **实时搜索**：输入地址任意部分即可筛选，支持前缀、后缀、中间片段
- ✅ **不区分大小写**：搜索时自动忽略大小写
- ✅ **智能匹配**：仅1个匹配时自动选中
- ✅ **快捷操作**：按回车键快速加载（仅1个匹配时）
- ✅ **实时计数**：显示当前匹配的地址数量
- ✅ **地址复制**：选中地址后显示可复制的文本框，支持一键复制完整地址

---

## 常见问题

### Q: 启动失败，提示端口被占用？
**A:** 运行停止脚本终止之前的服务，或者修改 `app.py` 中的端口号。

### Q: 停止脚本无效？
**A:** 尝试使用管理员权限运行，或者手动在任务管理器中结束 python.exe 进程。

### Q: 如何修改端口号？
**A:** 编辑 `app.py` 最后一行，将 `port=5000` 改为其他端口，如 `port=8080`。

### Q: 如何在后台运行？
**A:** 
- **Windows**: 使用 `pythonw app.py`（无窗口运行）
- **Linux/Mac**: 使用 `nohup python app.py > output.log 2>&1 &`

### Q: 计算完新数据后，如何让Web界面显示？
**A:** 
1. **方式1（推荐）**：点击页面上的"♻️ 刷新缓存"按钮
2. **方式2**：调用API：`curl -X POST http://localhost:5000/api/refresh-cache`
3. **方式3**：重启Web应用

### Q: 为什么切换时间区间这么快？
**A:** 应用启动时已将所有地址预加载到内存缓存中，切换时间区间不需要查询数据库。

---

## 目录结构

```
web/
├── app.py                  # Flask 后端主程序
├── 启动Web应用.bat          # 启动脚本（Windows）
├── 停止Web应用.bat          # 停止脚本（Windows）
├── stop_web_app.py         # 停止脚本（跨平台）
├── README.md              # 本文档
├── templates/             # HTML 模板
│   └── index.html
└── static/                # 静态资源
    ├── css/
    │   └── style.css
    └── js/
        └── main.js
```

---

## 技术栈

- **后端**: Flask + psycopg2 + pandas
- **前端**: HTML5 + CSS3 + JavaScript + ECharts
- **数据库**: TimescaleDB (PostgreSQL)

---

## 配置说明

数据库配置位于：`../config_timescale.py`

```python
TIMESCALE_CONFIG = {
    'host': 'your-host',
    'port': 39839,
    'database': 'tsdb',
    'user': 'your-user',
    'password': 'your-password'
}
```

---

## 开发提示

### 启用调试模式
在 `app.py` 最后一行已经启用：
```python
app.run(debug=True, host='0.0.0.0', port=5000)
```

调试模式特性：
- 代码修改后自动重载
- 显示详细错误信息
- 不建议在生产环境使用

### 生产环境部署
建议使用 gunicorn 或 uwsgi：
```bash
# 安装 gunicorn
pip install gunicorn

# 运行
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

---

## 更新日志

### v1.0.0
- ✅ 基础功能实现
- ✅ 多时间区间支持
- ✅ 多账户支持
- ✅ 实时数据查询
- ✅ 交互式图表
- ✅ 启动/停止脚本

---

## 许可证

内部使用
