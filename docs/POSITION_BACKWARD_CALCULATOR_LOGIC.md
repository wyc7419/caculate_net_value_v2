# 持仓反推计算器逻辑文档

## 概述

`PositionBackwardCalculator` 用于从最新快照开始，逐笔向前撤销事件，计算每个事件发生前的持仓状态。这是净值计算的基础数据。

---

## 核心思想

```
从已知的快照持仓出发，通过"撤销"事件影响，反推出历史每一刻的持仓状态
```

**为什么需要反推？**
- 快照只是定期记录的持仓状态（如每小时一次）
- 事件（交易、资金费等）会改变持仓
- 需要知道每个事件发生前后的精确持仓，才能正确计算净值

---

## 整体流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        持仓反推计算器流程                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  步骤1：从 API 加载快照数据                                                  │
│  ├─ 调用 DataLoader.load_snapshots_from_api()                              │
│  ├─ 获取 account_summary（快照时间点）                                       │
│  ├─ 获取 positions（合约持仓）                                               │
│  ├─ 获取 spot_balances（现货持仓）                                           │
│  └─ 按时间戳分组：{timestamp: {spot_positions, perp_positions}}              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  步骤2：获取事件数据                                                         │
│  ├─ 调用 EventImpactRecorder                                                │
│  │   ├─ 加载交易数据 (trades)                                               │
│  │   ├─ 加载资金费数据 (funding)                                             │
│  │   └─ 加载账本数据 (ledger)                                               │
│  ├─ 构建事件时间线（按时间倒序）                                              │
│  └─ 处理所有事件，记录影响（impacts）                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  步骤3：将快照插入到事件                                                      │
│  ├─ 对于每个事件 E_i（时间 T_i）                                             │
│  │   └─ 找到 (T_{i+1}, T_i] 范围内的快照                                    │
│  ├─ 如果有多个快照，选择时间最大的                                            │
│  ├─ 标记 is_snapshot_recorded = True                                        │
│  └─ 将快照数据写入 spot_snapshot, perp_snapshot 列                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  步骤4：逐笔撤销事件，计算持仓（核心）                                         │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  4.1 找到起始点（第一个 is_snapshot_recorded=True 的事件）              │   │
│  │      初始化：current_spot = 快照现货持仓                               │   │
│  │             current_perp = 快照合约持仓                               │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                              │                                               │
│                              ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  4.2 处理第一行：直接记录（不撤销）                                      │   │
│  │      spot_positions = current_spot                                     │   │
│  │      perp_positions = current_perp                                     │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                              │                                               │
│                              ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  4.3 从第二行开始循环（倒序遍历）                                        │   │
│  │                                                                        │   │
│  │      for idx in range(start_idx + 1, len(df)):                        │   │
│  │          ┌────────────────────────────────────────────────────────┐   │   │
│  │          │  A. 撤销现货事件                                         │   │   │
│  │          │     current_spot = undo_spot_event(                     │   │   │
│  │          │         current_spot,                                   │   │   │
│  │          │         spot_position_changes,                          │   │   │
│  │          │         spot_asset_change                               │   │   │
│  │          │     )                                                   │   │   │
│  │          └────────────────────────────────────────────────────────┘   │   │
│  │                              │                                         │   │
│  │                              ▼                                         │   │
│  │          ┌────────────────────────────────────────────────────────┐   │   │
│  │          │  B. 撤销合约事件                                         │   │   │
│  │          │     current_perp = undo_perp_event(                     │   │   │
│  │          │         current_perp,                                   │   │   │
│  │          │         perp_position_changes                           │   │   │
│  │          │     )                                                   │   │   │
│  │          └────────────────────────────────────────────────────────┘   │   │
│  │                              │                                         │   │
│  │                              ▼                                         │   │
│  │          ┌────────────────────────────────────────────────────────┐   │   │
│  │          │  C. 记录持仓                                             │   │   │
│  │          │     df[idx].spot_positions = current_spot               │   │   │
│  │          │     df[idx].perp_positions = current_perp               │   │   │
│  │          └────────────────────────────────────────────────────────┘   │   │
│  │                              │                                         │   │
│  │                              ▼                                         │   │
│  │          ┌────────────────────────────────────────────────────────┐   │   │
│  │          │  D. 快照校验（如果该行有快照）                            │   │   │
│  │          │     if is_snapshot_recorded:                            │   │   │
│  │          │         比较 current_spot vs spot_snapshot              │   │   │
│  │          │         比较 current_perp vs perp_snapshot              │   │   │
│  │          │         if 不一致:                                       │   │   │
│  │          │             打印警告                                     │   │   │
│  │          │             current_spot = spot_snapshot  ← 以快照为准   │   │   │
│  │          │             current_perp = perp_snapshot                │   │   │
│  │          └────────────────────────────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  步骤5：按时间戳正序排列                                                      │
│  └─ df.iloc[::-1]  ← 直接反转（不用 sort，同时间戳事件顺序也会正确反转）       │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  步骤6：导出结果（可选）                                                      │
│  └─ df.to_csv(output_csv_path)                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │   返回 DataFrame │
                          │  positions_df   │
                          └─────────────────┘
```

---

## 撤销逻辑详解

### 现货事件撤销 (`undo_spot_event`)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           现货事件撤销流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

输入：
├─ current_positions: {'BTC': 10.99, 'USDC': 10000}  ← 当前持仓
├─ position_changes:  {'BTC': 10, 'USDC': -500000}   ← 事件造成的变化
└─ asset_change:      -5.0                           ← USDC 手续费（仅feeToken==USDC时）

撤销逻辑：
┌──────────────────────────────────────────────────────────────────────────┐
│  步骤1：减去 position_changes                                             │
│                                                                          │
│  for coin, change in position_changes:                                   │
│      current_positions[coin] -= change                                   │
│                                                                          │
│  示例：                                                                   │
│      BTC:  10.99 - 10 = 0.99                                            │
│      USDC: 10000 - (-500000) = 510000                                   │
└──────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  步骤2：减去 asset_change（USDC 手续费）                                   │
│                                                                          │
│  if asset_change != 0:                                                   │
│      current_positions['USDC'] -= asset_change                           │
│                                                                          │
│  示例：                                                                   │
│      USDC: 510000 - (-5) = 510005                                       │
└──────────────────────────────────────────────────────────────────────────┘

输出：
└─ {'BTC': 0.99, 'USDC': 510005}  ← 事件发生前的持仓
```

---

### 合约事件撤销 (`undo_perp_event`)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           合约事件撤销流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

输入：
├─ current_positions: [{'coin': 'BTC', 'amount': 10, 'dir': 'long'}]
└─ position_changes:  {'BTC': {'amount': 5, 'side': 'B', 'dir': 'Open Long'}}

撤销逻辑（基于 side）：
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  if side == 'B':  # 买入                                                 │
│      撤销 = 减去                                                          │
│      new_amount = current_amount - sz                                    │
│                                                                          │
│  elif side == 'A':  # 卖出                                               │
│      撤销 = 加回                                                          │
│      new_amount = current_amount + sz                                    │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘

示例：

┌─────────────────────────────────────────────────────────────────────────┐
│  场景1：撤销买入 (side='B')                                              │
│                                                                         │
│  当前持仓: BTC = 10 (多头)                                               │
│  事件: 买入 5 BTC                                                        │
│  撤销: 10 - 5 = 5                                                       │
│  结果: BTC = 5 (多头)                                                    │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  场景2：撤销卖出 (side='A')                                              │
│                                                                         │
│  当前持仓: BTC = -5 (空头)                                               │
│  事件: 卖出 10 BTC                                                       │
│  撤销: -5 + 10 = 5                                                      │
│  结果: BTC = 5 (多头)  ← 方向从空变多                                     │
└─────────────────────────────────────────────────────────────────────────┘

方向判断：
├─ amount > 0 → dir = 'long'
├─ amount < 0 → dir = 'short'
└─ amount = 0 → 删除该币种
```

---

## 快照插入逻辑

### 核心规则

对于每个事件 E_i（时间 T_i）：
1. 找到在 **(T_{i+1}, T_i)** 范围内的快照（即：大于上一个事件时间，**严格小于**当前事件时间）
2. 如果有多个快照，选择**时间最大的**（离当前事件最近的）
3. 将快照关联到事件 E_i

> ⚠️ **边界情况**：如果快照时间 == 事件时间，该快照**不会被关联**，因为无法确定先后顺序

### 详细示例

假设有以下数据：

**事件列表（按时间倒序）：**
```
idx=0: 事件D  时间=12:00  (最新)
idx=1: 事件C  时间=11:30
idx=2: 事件B  时间=11:00
idx=3: 事件A  时间=10:00  (最早)
```

**快照列表：**
```
快照1  时间=10:30
快照2  时间=10:45
快照3  时间=11:15
快照4  时间=11:40
```

**插入过程：**

```
时间轴：
10:00    10:30    10:45    11:00    11:15    11:30    11:40    12:00
  │        │        │        │        │        │        │        │
事件A    快照1    快照2    事件B    快照3    事件C    快照4    事件D
  │                          │                  │                 │
  └────────────────────────────────────────────────────────────────┘
                              倒序遍历方向 ←
```

**对每个事件进行快照匹配：**

| idx | 事件 | 时间 | 查找范围 | 范围内的快照 | 选中的快照 |
|-----|------|------|----------|--------------|------------|
| 0 | 事件D | 12:00 | (11:30, 12:00] | 快照4(11:40) | **快照4** ✅ |
| 1 | 事件C | 11:30 | (11:00, 11:30] | 快照3(11:15) | **快照3** ✅ |
| 2 | 事件B | 11:00 | (10:00, 11:00] | 快照1(10:30), 快照2(10:45) | **快照2** ✅ (时间最大) |
| 3 | 事件A | 10:00 | (0, 10:00] | 无 | 无 |

**结果 DataFrame：**

```
idx | 事件  | 时间   | is_snapshot_recorded | spot_snapshot | perp_snapshot
----|-------|--------|---------------------|---------------|---------------
 0  | 事件D | 12:00  | True                | 快照4的数据    | 快照4的数据
 1  | 事件C | 11:30  | True                | 快照3的数据    | 快照3的数据
 2  | 事件B | 11:00  | True                | 快照2的数据    | 快照2的数据
 3  | 事件A | 10:00  | False               | None          | None
```

### 为什么这样设计？

```
撤销事件B之后的持仓状态 ←────────────────┐
                                        │
时间轴：                                  │
10:00      10:45      11:00              │
  │          │          │                │
事件A      快照2      事件B               │
  │          │          │                │
  │          └──────────┼────── 快照2 记录的是这个时刻的持仓
  │                     │                │
  │                     └─ 撤销事件B后，持仓应该等于快照2
  │                                      │
  └──────────────────────────────────────┘
```

**关键理解：**
- 快照记录的是**某一时刻的真实持仓**
- 快照2(10:45) 在事件B(11:00) 之前，说明在 10:45~11:00 之间没有其他事件
- 所以 **撤销事件B后的持仓** 应该等于 **快照2的持仓**
- 这就是为什么快照2要关联到事件B：用于校验撤销后的结果

### 多快照选择示例

当一个区间内有多个快照时：

```
时间轴：
10:00    10:30    10:45    11:00
  │        │        │        │
事件A    快照1    快照2    事件B
          │        │
          └────────┴── 两个快照都在 (10:00, 11:00] 范围内
                       选择 快照2（时间最大，离事件B最近）
```

**为什么选时间最大的？**
- 快照2(10:45) 比快照1(10:30) 更接近事件B(11:00)
- 快照2更能代表事件B发生前的状态
- 用快照2校验更准确

---

## 快照校验机制

### 误差容忍规则

**规则：绝对误差 ≤ 0.01 或 相对误差 ≤ 1%，满足任一即通过**

```python
abs_tol = 0.01  # 绝对误差阈值
rel_tol = 0.01  # 相对误差阈值 (1%)

diff = abs(calc_amount - snap_amount)

# 条件1：绝对误差 ≤ 0.01
if diff <= abs_tol:
    return True

# 条件2：相对误差 ≤ 1%
if abs(snap_amount) > 1e-10:
    relative_error = diff / abs(snap_amount)
    if relative_error <= rel_tol:
        return True

return False
```

**设计原因：**

| 场景 | 绝对误差 | 相对误差 | 判断 |
|------|----------|----------|------|
| 大金额：1000 → 999 | 1 > 0.01 ❌ | 0.1% ≤ 1% ✅ | **通过** |
| 小金额：0.00001 → 0.000005 | 0.000005 ≤ 0.01 ✅ | 50% > 1% ❌ | **通过** |
| 真实差异：100 → 90 | 10 > 0.01 ❌ | 10% > 1% ❌ | **失败** |

### 校验流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           快照校验流程                                        │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │ 撤销事件后的持仓  │
                    │ current_spot    │
                    │ current_perp    │
                    └────────┬────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │  该行有快照？                  │
              │  is_snapshot_recorded == True │
              └──────────────┬───────────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
              ▼                             ▼
         ┌────────┐                   ┌────────┐
         │   是    │                   │   否   │
         └────┬───┘                   └────┬───┘
              │                             │
              ▼                             ▼
    ┌─────────────────────────┐       ┌─────────────────┐
    │ 比较计算持仓 vs 快照持仓  │       │ 跳过校验         │
    │ 绝对误差≤0.01 或         │       │ 继续下一个事件   │
    │ 相对误差≤1% 即通过       │       └─────────────────┘
    └───────────┬─────────────┘
                │
    ┌───────────┴───────────┐
    │                       │
    ▼                       ▼
┌──────────────┐     ┌──────────────┐
│ 满足任一 ✅   │     │ 都不满足 ⚠️   │
│ 校验通过      │     │ 校验失败      │
└──────┬───────┘     └──────┬───────┘
      │                │
      │                ▼
      │      ┌─────────────────────┐
      │      │ 打印警告             │
      │      │ 显示差异详情         │
      │      │ 显示相对误差百分比    │
      │      └─────────┬───────────┘
      │                │
      └────────┬───────┘
               │
               ▼
    ┌─────────────────────┐
    │ 用快照替换计算持仓    │  ← 无论是否通过，都用快照替换
    │ current = snapshot  │     防止误差累积
    └─────────────────────┘
```

### 设计说明

| 要点 | 说明 |
|------|------|
| **双阈值策略** | 绝对误差 ≤0.01 或 相对误差 ≤1%，兼顾大小金额 |
| **大金额友好** | 1000 USDC 差 1 → 相对误差 0.1%，通过 |
| **小金额友好** | 0.00001 差 0.000005 → 绝对误差 < 0.01，通过 |
| **始终替换** | 无论校验是否通过，都用快照数据替换，防止误差累积 |
| **显示百分比** | 校验失败时显示相对误差百分比，便于判断问题严重程度 |

---

## 数据结构说明

### 输入数据

| 数据源 | 格式 | 说明 |
|--------|------|------|
| 快照 | `{timestamp: {spot_positions, perp_positions}}` | 定期记录的持仓状态 |
| 事件 | `[{time, type, changes, ...}]` | 交易/资金费/账本事件 |

### 输出 DataFrame

| 列名 | 类型 | 说明 |
|------|------|------|
| `event_number` | str | 事件编号 |
| `time` | str | 时间字符串 |
| `timestamp` | int | 毫秒时间戳 |
| `event_category` | str | 事件大类（trade/funding/ledger） |
| `event_type` | str | 事件子类型 |
| `closedPnl` | str | 已实现盈亏 |
| `spot_position_changes` | str | 现货持仓变化 |
| `spot_asset_change_ex_position` | str | 现货资产变化（手续费等） |
| `spot_positions` | str | 撤销后的现货持仓 |
| `spot_snapshot` | dict | 快照现货持仓（如有） |
| `perp_position_changes` | str | 合约持仓变化 |
| `perp_asset_change_ex_position` | str | 合约资产变化（资金费等） |
| `perp_positions` | str | 撤销后的合约持仓 |
| `perp_snapshot` | list | 快照合约持仓（如有） |
| `is_snapshot_recorded` | bool | 是否有关联的快照 |
| `share_change` | str | 份额变化 |

---

## 关键概念

| 概念 | 说明 |
|------|------|
| **倒序遍历** | 从最新事件向最早事件方向遍历 |
| **撤销事件** | 反向操作，计算事件发生前的状态 |
| **快照校验** | 绝对误差 ≤0.01 或 相对误差 ≤1%，满足任一即通过 |
| **始终替换** | 无论校验是否通过，都用快照数据替换，防止误差累积 |
| **绝对误差** | `abs(计算值 - 快照值)`，差多少 |
| **相对误差** | `abs(差值) / abs(快照值)`，差多少比例 |
| **side 字段** | 'B'=买入，'A'=卖出，用于合约撤销 |
| **is_snapshot_recorded** | 标记该行是否有可用于校验的快照 |

---

## 注意事项

### 1. 事件顺序

- 事件 DataFrame 初始为**倒序**（最新在前）
- 遍历时从 `start_idx` 向后（更早的事件）
- 最终输出按**正序**排列（最早在前）

### 2. 快照时间精度

- 快照时间精确到**毫秒**
- 避免因秒级精度导致的快照匹配错误

### 3. 校验与替换

- **规则**：绝对误差 ≤ 0.01 或 相对误差 ≤ 1%，满足任一即通过
- 校验通过：静默替换
- 校验失败：打印警告和误差详情
- **无论是否通过，都用快照数据替换**，防止误差累积到下一个快照

### 4. 最新快照后的事件

- 最新快照之后的事件会被跳过
- 因为没有快照可以初始化持仓

---

## 相关文件

| 文件 | 用途 |
|------|------|
| `calculate_positions_backward.py` | 持仓反推计算器主程序 |
| `event_impact_recorder.py` | 事件影响记录（计算 position_changes） |
| `data_loader.py` | 从 API 加载快照和事件数据 |
| `caculate_net_value_v2.py` | 使用本模块的输出计算净值 |

