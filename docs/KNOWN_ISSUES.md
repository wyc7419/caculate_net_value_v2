# 已知问题列表

本文档记录净值计算系统中目前已知但尚未解决的问题。

---

## 问题1：合约交易 feeToken 非 USDC

**问题描述：**
在记录事件影响时，合约交易的 `feeToken` 并非总是 USDC，有时会是 USDH 等其他代币，原因是用户交易了 HIP-3 代币。

**技术解释：**
HIP-3 是 Hyperliquid 的原生代币协议，允许用户在平台上创建和交易自定义代币。当用户交易 HIP-3 代币时，手续费可能以该代币或其他非 USDC 稳定币（如 USDH）支付。当前代码在处理 `spot_asset_change_ex_position` 时，可能假设手续费币种为 USDC，导致：
- 手续费资产变化记录到错误的币种
- 现货持仓计算出现偏差

**影响范围：**
- `EventImpactRecorder` 中的现货交易手续费处理
- 现货账户价值计算

---

## 问题2：现货交易对仅支持 USDC 计价

**问题描述：**
现在交易币对默认都是跟 USDC 的，USDH、USDT 等其他计价币种的逻辑没有加上。

**技术解释：**
Hyperliquid 现货市场不仅支持 `XXX/USDC` 交易对，还可能存在：
- `XXX/USDH` 交易对
- `XXX/USDT` 交易对
- 其他稳定币计价的交易对

当前代码在处理现货交易时，`spot_position_changes` 中的 USDC 变化量计算是基于 `XXX/USDC` 假设的。如果实际交易对是 `XXX/USDH`，则：
- 应该记录 USDH 的变化而非 USDC
- 价格获取也需要使用对应的交易对

**影响范围：**
- `EventImpactRecorder.record_spot_trade_impact()`
- 现货持仓变化计算
- K 线价格获取

---

## 问题3：HIP-3 代币价格无法获取

**问题描述：**
HIP-3 代币的价格无法通过现有的 K 线 API 获取。

**技术解释：**
HIP-3 代币是 Hyperliquid 平台上用户创建的自定义代币，具有以下特点：
- 币种代码通常为 `@` 开头的数字编号（如 `@10`、`@142`）
- 部分 HIP-3 代币可能没有足够的交易深度，导致 K 线数据不可用
- Hyperliquid 的 K 线 API 可能不支持所有 HIP-3 代币

当前 `kline_fetcher.py` 在获取这些代币价格时会失败，导致：
- `preload_prices()` 无法加载价格数据
- 现货账户价值计算为 0 或不准确
- 净值曲线出现异常

**影响范围：**
- `KlineFetcher.get_open_prices()`
- `NetValueCalculatorV2.preload_prices()`
- `NetValueCalculatorV2.calculate_spot_account_value()`

---

## 问题4：部分账本事件类型未经测试

**问题描述：**
记录事件影响中的内部转账、子账户转账等事件类型无法测试，逻辑正确性不确定。

**技术解释：**
以下账本事件类型由于缺乏测试数据，处理逻辑可能存在问题：

| 事件类型 | 说明 | 测试状态 |
|----------|------|----------|
| `internalTransfer` | 内部转账（同地址不同账户） | ❓ 未测试 |
| `subAccountTransfer` | 子账户转账 | ❓ 未测试 |
| `send` | 代币发送 | ❓ 未测试 |
| `receive` | 代币接收 | ❓ 未测试 |
| `vaultCreate` | 创建金库 | ❓ 未测试 |
| `vaultLeaderCommission` | 金库领导佣金 | ❓ 未测试 |

这些事件的处理逻辑是基于 API 文档和推测实现的，可能存在：
- 字段解析错误
- 资产变化方向判断错误
- 份额变化计算错误

**影响范围：**
- `EventImpactRecorder` 中对应事件的处理方法
- 持仓反推校验
- 份额变化计算

---

## 问题5：快照时间戳精度问题导致校验失败

**问题描述：**
撤销事件影响时，加载的快照数据可能包含多条记录，但它们共用同一个时间戳。实际上，快照采集可能持续数秒甚至十几秒，如果在采集期间发生了交易，会导致校验出现问题。

**技术解释：**
API 返回的快照数据结构如下：
```json
{
  "snapshot_time": "2025-09-14 09:50:01.000000+0000",
  "positions": [...],      // 多条持仓记录
  "spot_balances": [...]   // 多条现货余额记录
}
```

问题在于：
1. 所有数据使用同一个 `snapshot_time`
2. 实际采集过程可能持续 5-15 秒
3. 采集期间如果有交易发生，快照数据与真实持仓不一致

**示例地址：**
`0x06459273920defe761a706a9fa64a2e2fb3989de`

**影响表现：**
- 快照校验失败（计算持仓与快照持仓不一致）
- 相对误差可能超过 1% 阈值
- 需要依赖快照数据替换来修正

**当前处理：**
系统已实现"无论校验是否通过都用快照替换"的策略，可以部分缓解此问题。但如果交易量大、快照采集时间长，仍可能影响数据准确性。

**可能的改进方向：**
- 使用快照中每条记录的独立时间戳（如果 API 支持）
- 在快照采集期间标记为"不可靠"
- 增加时间窗口容忍度

---

## 更新记录

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2025-12-05 | v1.0 | 初始创建，记录 5 个已知问题 |

